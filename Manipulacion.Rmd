---
title: "Manipulando data con los datos del Barómetro de las Américas"
author: "Arturo Maldonado"
date: "18/02/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## INTRODUCCIÓN
En este documento se verán aspectos básico de la manipulación de datos, como la recodificación de una variable, la selección de datos y el cálculo de una nueva variable.

## SOBRE LA BASE DE DATOS
Los datos que vamos a usar deben citarse de la siguiente manera:
Fuente: Barómetro de las Américas por el Proyecto de Opinión Pública de América Latina (LAPOP), wwww.LapopSurveys.org.
Pueden descargar los datos de manera libre  [aquí](http://datasets.americasbarometer.org/database/login.php)
En este enlace, se pueden registrar o entrar como "Free User". En el buscador, se puede ingresar el texto "merge". Ahí se tendrá acceso a la base de datos completa "2004-2018 Grand Merge Free" en versión para STATA. Se descarga la base de datos en formato zip, la que se descomprime en formato .dta.
Una vez descargada y guardada en el directorio de trabajo, se tiene que leer la base de datos como un objeto dataframe en R. 

```{r base}
library(haven)
lapop <- read_dta("/Users/Arturo/OneDrive - Vanderbilt/C LAPOP/Data/LAPOP_Merge_2004_2018.dta")
```

## RECODIFICACIÓN DE UNA VARIABLE
El reporte "El Pulso de la Democracia" presenta los resultados acerca del apoyo a la democracia en las Américas. Estos resultados se basan en la variable ING4 de la base de datos.
Esta variable está fraseada de la siguiente manera:
ING4. Cambiando de nuevo de tema, puede que la democracia tenga problemas, pero es mejor que cualquier otra forma de gobierno. ¿Hasta qué punto está de acuerdo o en desacuerdo con esta frase?
Como indica el reporte "los entrevistados evalúan esta frase dando una respuesta que va de 1 a 7, donde 1 significa "muy en desacuerdo" y 7 significa "muy de acuerdo" (p.11). 
Para ver la distribución de respuestas a esta variable, se puede usar el comando `table`.
```{r describir ing4}
table(lapop$ing4)
```

El reporte nos indica la forma de recodificación: "Se consideran las respuestas en la porción de la escala que indica estar de acuerdo, esto es los valores de 5 a 7, para indicar el porcentaje que apoya a la democracia" (p.11).
Es decir, la variable original ING4 se tiene que recodificar en una nueva variable, siguiendo la siguiente regla:
1. Valores entre 1-4 de ING4 se transforman en 0 en la nueva variable ing4r
2. Valores entre 5-7 de ING4 se transformen en 1 en la nueva variable ing4r

Para poder recodificar una variable hay varias formas. Una de las formas más eficientes de hacerlo es usando el comando `recode` del paquete `car`. El paquete `dplyr` tiene un comando `recode` que puede confundir a R. Para evitar confusiones usaremos `car::recode`.
En este caso, la sintaxis para hacer la recodificación  y para comprobarla es:
```{r recodificación}
lapop$ing4rec <- car::recode(lapop$ing4, "1:4=0; 5:7=1")
table(lapop$ing4rec)
```

## SELECCIÓN DE CASOS
El reporte indica que "El Gráfico 1.1 muestra el porcentaje de personas en cada país que expresa apoyar la democracia en 2018/19. El apoyo a la democracia va de un mínimo de 45% en Honduras a un máximo de 76.2% en Uruguay" (p.11).
Para replicar estos resultados acerca de Honduras y acerca de Uruguay para 2018/19, se tiene que, en primer lugar, seleccionar los datos de esa ronda y luego seleccionar los datos de esos países.
La selección de casos en R se puede hacer de múltiples maneras. Una forma es usar []. Por ejemplo, para seleccionar los datos de la última ronda y guardarla en un nuevo dataframe.
```{r seleccionar 2018/19}
lapop18 <- lapop[lapop$wave == 2018, ]
table(lapop18$wave)
dim(lapop18)
```

Con esta sintaxis se ha seleccionado las 1370 variables de la ronda 2018/19, que tiene 31050 observaciones. Este dataframe tiene observaciones de todos los países incluidos en esta ronda.
```{r pais en lapop18}
table(lapop18$pais)
```

De este grupo se tiene que seleccionar a Honduras y a Uruguay. De acuerdo al cuestionario, que se puede ver [aquí](https://www.vanderbilt.edu/lapop/ab2018/AB2018-v12.0-Spa-190131_W.pdf), Honduras es el país 4 y Uruguay es el país 14.
Para seleccionar estos países también se puede usar el comando `subset` y guardar esta selección en un nuevo dataframe.
```{r seleccionar países}
lapop2 <- subset(lapop18, pais==4 | pais==14)
table(lapop2$pais)
```

Este último dataframe contiene las observaciones de la ronda 2018/19 y de Honduras y Uruguay. Con esta selección de datos, se puede calcular los porcentajes reportados usando el comando `prop.table` y multiplicando  por 100 para reproducir el porcentaje.
```{r porcentajes}
prop.table(table(lapop2$ing4rec[lapop2$pais==4]))*100
prop.table(table(lapop2$ing4rec[lapop2$pais==14]))*100
```

Para redondear a un decimal, como se muestra en el Gráfico 1.2, se puede usar el comando `round`. 
```{r redondear}
round(prop.table(table(lapop2$ing4rec[lapop2$pais==4]))*100, 1)
round(prop.table(table(lapop2$ing4rec[lapop2$pais==14]))*100, 1)
```

## CALCULAR UNA VARIABLE
Una práctica frecuente de LAPOP con los datos del Barómetro de las Américas es el reescalamiento de variables. El capítulo sobre Legitimidad democrática del reporte brinda ejemplos de este reescalamiento de variables relacionadas al apoyo al sistema.
Para calcular este índice de apoyo al sistema se trabaja con un conjunto de cinco variables: 

B1. ¿Hasta qué punto cree usted que los tribunales de justicia de (país) garantizan un juicio justo? [Sondee: Si usted cree que los tribunales no garantizan para nada la justicia escoja el número 1; si cree que los tribunales garantizan mucho la justicia, escoja el número 7 o escoja un puntaje intermedio].
B2. ¿Hasta qué punto tiene usted respeto por las instituciones políticasl de (país)? 
B3. ¿Hasta qué punto cree usted que los derechos básicos del ciudadano están bien protegidos por el sistema político de (país)? 
B4. ¿Hasta qué punto se siente orgulloso de vivir bajo el sistema político de (país)?
B6. ¿Hasta qué punto piensa usted que se debe apoyar al sistema político de (país)?

Como indica el reporte "Para cada pregunta, la escala original de 1 ("Nada") a 7 ("Mucho") se recodifica en una escala de 0 a 100, de tal forma que 0 indica el menor nivel de apoyo al sistema político y 100 es el nivel máximo de apoyo al sistema político. Esta nueva escala sigue la recodificación típica de LAPOP y puede ser interpretada como una medición del apoyo en unidades, o grados, en una escala continua que va de 0 a 100" (p.34).
Para comprobar la escala original de estas variables, se puede describir estas variables.
```{r describir}
table(lapop$b1)
table(lapop$b2)
table(lapop$b3)
table(lapop$b4)
table(lapop$b6)
```


Para reescalar una variable en una escala original de 1 a 7 a otra de 0 a 100, lo primero que se tiene que hacer es restar 1 unidad, con lo que la variable tendría una escala de 0 a 6, luego dividirla entre 6, con lo que variaría entre 0 y 1 y, finalmente, multiplicarla por 100. Esto es:
Variable reescalada = ((variable original -1)/6)*100
El código para calcular esta nueva variable reescalada es:
```{r calcular}
lapop$b1rec <- ((lapop$b1-1)/6)*100
lapop$b2rec <- ((lapop$b2-1)/6)*100
lapop$b3rec <- ((lapop$b3-1)/6)*100
lapop$b4rec <- ((lapop$b4-1)/6)*100
lapop$b6rec <- ((lapop$b6-1)/6)*100
table(lapop$b1rec)
```

Con esta transformación se observa que los 38,849 entrevistados que marcaron 1 en la pregunta B1, ahora tienen un puntaje de 0. Los 31,053 que marcaron 2, ahora tienen un puntaje de 16.67, es decir 2-1=1/6=0.1667*100=16.67.
Esta misma operación se pudo hacer con el comando `car::recode`, siguiendo la siguiente regla de recodificación:
- Valor de 1 en variable original se recodifica como 0 en nueva variable
- Valor de 2 en variable original se recodifica como 16.67 en nueva variable
- Valor de 3 en variable original se recodifica como 33.33 en nueva variable
- Valor de 4 en variable original se recodifica como 50 en nueva variable
- Valor de 5 en variable original se recodifica como 66.67 en nueva variable
- Valor de 6 en variable original se recodifica como 83.33 en nueva variable
- Valor de 7 en variable original se recodifica como 100 en nueva variable

Esta manera de recodificar, sin embargo, es poco eficiente. Es más simple usar la fórmula para calcular la recodificación.

Para calcular el índice de apoyo al sistema, el reporte indica que "El índice de apoyo al sistema es el promedio de cinco preguntas: B1, B2, B3, B4 y B6" (p.46).
Es decir, con las variables reescaladas se tiene que calcular el promedio de estas cinco variables para cada individuo. Esta operación se puede realizar calculando el promedio de forma manual.
Apoyo al sistema = (b1rec + b2rec + b3rec + b4rec + b6rec)/5
En R tenemos el comando `rowMeans` que sirva para calcular promedios de ciertas columnas por filas.
```{r apoyo al sistema}
lapop$apoyo <- rowMeans(lapop[,1371:1375])
table(lapop$apoyo)
```

Con este índice se puede calcular el apoyo al sistema promedio para la última ronda del Barómetro de las Américas, así como los promedios de cada una de las variables que componen el índice. Estos estadísticos se verán en más detalle en otros documentos.
```{r apoyo al sistema 2018/19}
mean(lapop$apoyo[lapop$wave==2018], na.rm=T)
mean(lapop$b1rec[lapop$wave==2018], na.rm=T)
mean(lapop$b2rec[lapop$wave==2018], na.rm=T)
mean(lapop$b3rec[lapop$wave==2018], na.rm=T)
mean(lapop$b4rec[lapop$wave==2018], na.rm=T)
mean(lapop$b6rec[lapop$wave==2018], na.rm=T)
```

Estos valores no son exactamente iguales a los que aparecen en el reporte por dos motivos. En primer lugar, debido a que "Los valores a lo largo del tiempo se calculan incluyendo únicamente los países que el Barómetro de las Américas ha estudiado regularmente desde 2006: Argentina, Brasil, Bolivia, Chile, Colombia, Costa Rica, República Dominicana, Ecuador, El Salvador, Guatemala, Honduras, Jamaica, México, Nicaragua, Panamá, Paraguay, Perú, Uruguay" (p.46). 
El código solo filtra la última ronda, que incluye países que no están en esa lista, como Estados Unidos o Canadá.
De otro lado, los cálculos reportados en la publicación incluyen ponderaciones, que no se han incluido en estos cálculos, pero que en otros documentos se incorporarán.
